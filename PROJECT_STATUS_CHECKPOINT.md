# KYUNGSA 프로젝트 현황 체크포인트

> **목적**: 외부 전문가(경매 실무 + 소프트웨어 아키텍처) 교차 검증용
> **작성 기준**: 실제 구현 코드 기반 사실만 기재 (2026-02-17)
> **현재 단계**: Phase 5E 완료 (RuleEngine v2 통합) — 실서버 배치 수집 가동 중

---

## 1. 서비스 목적 및 핵심 가설

### 서비스 목적
대한민국 법원 경매 물건 중 **분석 가치가 없는 70%를 자동 필터링**하여, 실무 투자자가 검토해야 할 물건만 정제해서 제공하는 경매 큐레이션 시스템.

**핵심 원칙** (코드에 하드코딩된 제약):
- LLM은 자연어 설명 전용. 판단·점수·추천은 반드시 수식/룰 기반.
- 공개 출력에 "예측", "적정가", "입찰가", "추천" 사용 금지.
- Hard Stop 미탐지율 0% (위험 물건 통과 금지).

### 핵심 가설 (검증 필요)
1. 대법원 경매 물건의 30% 이상이 등기부·용도지역·유찰이력 기준으로 즉시 제외 가능하다.
2. 남은 물건에서 법률 리스크와 가격 매력도 점수로 상위 10~20%를 실익 있는 물건으로 분류할 수 있다.

---

## 2. 시스템 아키텍처

```
[대법원 경매정보] ──→ CourtAuctionClient (HTTP 크롤러)
[건축물대장 API]  ──→                               \
[Vworld 용도지역] ──→   CaseEnricher (데이터 보강)   ──→ FilterEngine
[실거래가 API]   ──→                               /     (RED/YELLOW/GREEN)
[카카오 Geocode]  ──→                              /           │
                                                         CostGate
                                                              │ passed=True
                                                         [선택적 2단]
                                                    CODEF 주소검색 + 등기부열람
                                                              │
                                                    RegistryParser/Analyzer
                                                              │
                                                    LegalScorer (5C)
                                                              │
                                              PriceScorer (5D) + TotalScorer (5E)
                                                              │
                                                    PostgreSQL 16 (scores 테이블)
```

### 기술 스택
- **Backend**: Python 3.11, FastAPI, SQLAlchemy 2.0, Alembic
- **DB**: PostgreSQL 16 (홈서버: Ubuntu 24.04 LTS, MSI GP75)
- **배포**: systemd + uvicorn, Tailscale VPN 원격 접근
- **스케줄링**: systemd timer (매일 03:00 서울 법원 5개 순차 수집)
- **외부 API**: 대법원, data.go.kr, Vworld, 카카오, CODEF

---

## 3. 데이터 파이프라인

### 1단 필터링 (무료, 항상 실행)

**데이터 소스 5개:**

| # | 데이터 | 출처 | 활용 |
|---|--------|------|------|
| 1 | 경매 사건 정보 | 대법원 courtauction.go.kr | 감정가, 최저가, 유찰횟수, 물건종류 |
| 2 | 건축물대장 | apis.data.go.kr | 용도·위반건축물 여부 |
| 3 | 토지이용계획 | Vworld LT_C_UQ111 | 용도지역·개발제한구역 |
| 4 | 실거래가 | apis.data.go.kr | 시세 대비 감정가 괴리율 |
| 5 | 주소/좌표 | 카카오 + Vworld | API 연결 좌표 |

**수집 방식:**
- 페이지네이션 전체 수집 (`totalYn=Y`)
- Per-case commit (장애 시 복원 가능)
- Skip-existing + force_update 옵션
- PipelineRun 추적 (run_id, 상태 RUNNING→COMPLETED)

**Fail-open 정책**: 각 API 개별 실패 시 해당 데이터 없이 EnrichedCase 반환 (전체 파이프라인 중단 없음)

### 2단 등기부 분석 (선택적, 건당 ~700원)

**현재 상태**: 1단 필터 통과(YELLOW/GREEN) 물건에 대해 수동 트리거 가능. 배치 자동화는 비용 상 보류.

**CODEF 경로:**
1. 주소 파싱 → `CodefAddressParams`
2. CODEF 등기부 주소검색 → `uniqueNo` (고유번호)
3. CODEF 등기부열람 (`inquiryType=0`) → JSON 응답
4. `CodefRegistryMapper` → `RegistryDocument` (갑구/을구 이벤트 리스트)
5. `RegistryAnalyzer` → 말소기준권리 판별 + 인수/소멸 분류 + Hard Stop 탐지

**PDF 경로:** 수동 업로드 → `RegistryParser` → 동일한 `RegistryDocument` 경유

---

## 4. 필터링 룰 명세

### 1단 색상 필터 (filter_rules.py + filter_engine.py)

| 구분 | 코드 | 조건 | 근거 |
|------|------|------|------|
| RED (즉시 제외) | R001 | 그린벨트 (개발제한구역) | Vworld 용도지역 "개발제한구역지구" 포함 |
| RED | R002 | 위반건축물 표시 | 건축물대장 `vltnBldYn = "Y"` |
| RED | R003 | 토지단독 (건물 없음) | 물건 유형에 "토지" + 건축물 미존재 |
| YELLOW (주의) | Y001 | 유찰 3회 이상 | `auction_count >= 4` |
| YELLOW | Y002 | 시세 괴리 30% 이상 | `abs(appraised - market) / market > 0.3` |
| YELLOW | Y003 | 건축물대장 미확인 | 건축물 API 응답 없음 |
| GREEN | — | 위 조건 미해당 | → 2단 진행 가능 |

**CostGate**: RED → `passed=False` (2단 등기부 열람 차단), YELLOW/GREEN → `passed=True`

### 2단 Hard Stop 룰 (registry_rules.py + registry_analyzer.py)

| 코드 | 조건 | 탐지 근거 |
|------|------|----------|
| HS001 | 예고등기 존재 | 갑구에 예고등기 EventType, 미말소 |
| HS002 | 신탁등기 존재 | 갑구에 신탁 EventType, 미말소 |
| HS003 | 가처분등기 존재 | 갑구에 PROVISIONAL_DISPOSITION, 미말소 |
| HS004 | 환매특약등기 존재 | 갑구에 환매특약 EventType, 미말소 |
| HS005 | 법정지상권 성립 요건 | 토지/건물 소유자 상이 + 저당권 설정 시 동일소유 |

**원칙**: 애매한 조건은 Hard Stop이 아닌 Yellow Zone으로 강등 (오탐 > 미탐 허용).

---

## 5. 점수 체계

### 5-A. 법률 리스크 점수 (LegalScorer, 5C)

**입력**: `RegistryAnalysisResult` + `AuctionCaseDetail`
**범위**: 0~100 (높을수록 안전)

```
base_score = mortgage_score × 0.40
           + seizure_score  × 0.30
           + surviving_score × 0.30

final_score = base_score × confidence_multiplier
```

**신뢰도 계수:**
- HIGH (파싱 완전): × 1.0
- MEDIUM: × 0.8
- LOW: × 0.6
- Hard Stop 존재: final_score = 0

### 5-B. 법률 점수 세부 공식 (검증 요청 항목)

**① 근저당 비율 점수 (`mortgage_score`)**

`ratio = 총 근저당 채권최고액 / 감정가`

| 구간 | 아파트 점수 | 꼬마빌딩 점수 |
|------|------------|--------------|
| 0 | 100 | 100 |
| 0~0.5 | 선형 100→80 | 선형 100→80 |
| 0.5~0.6 | 선형 (계속) | 80 (꺾임 시작) |
| 0.6~0.7 | 선형 80→(계속) | 선형 80→50 |
| 0.6~0.8 | 선형 80→50 | — |
| 0.7~1.0 | — | 선형 50→20 |
| 0.8~1.0 | 선형 50→25 | — |
| 1.0~2.0 | 선형 25→0 | 선형 20→0 |
| >2.0 | 0 | 0 |

> **검증 질문**: 채권최고액은 실대출의 110~120%가 통상. 따라서 ratio=1.0이면 실대출이 감정가 수준. 이 곡선이 실제 경매 데이터에서 낙찰 결과와 상관관계가 있는가?

**② 가압류/가처분 점수 (`seizure_score`)**

건수 감점 (캡 70):
- 0건: 0점
- 1건: -20점
- 2건: -35점
- 3건 이상: -50점

금액 감점 (`seizure_ratio = 총가압류 / 감정가`):
- ≤0.05: -5점
- 0.05~0.2: -10~25점 (선형)
- 0.2~0.5: -25~40점 (선형)
- >0.5: -40~50점 (캡 50)

소유권 관련 가처분: 별도 -60점 (`needs_expert_review=True`)

> **검증 질문**: 가압류 1건에 -20점은 너무 가혹한가, 아니면 부족한가? 배당요구 여부에 따라 실손실이 크게 달라지는데, 현재 배당요구 데이터가 없다.

**③ 인수 권리 점수 (`surviving_score`)**

`surviving_ratio = 인수 권리 총액 / 감정가`
- ≤0.1: -0~10점 (선형)
- 0.1~0.3: -10~40점
- 0.3~0.5: -40~70점
- >0.5: -70~100점 → `needs_expert_review=True`

---

### 5-C. 가격 매력도 점수 (PriceScorer, 5D)

**입력**: `AuctionCaseDetail` + `MarketPriceInfo`
**범위**: 0~100 (높을수록 좋은 거래)

**동적 가중치** (시세 데이터 유무에 따라 전환):

| 구간 | 시세 있을 때 | 시세 없을 때 |
|------|------------|------------|
| 할인율 | 0.15 | 0.60 |
| 시세 대비 | 0.55 | — |
| 감정가 신뢰도 | 0.30 | 0.40 |

> **설계 근거**: 할인율과 시세대비가 `감정가≈시세`일 때 double counting → 동적 가중치로 해소. 감정가 고평가 시 할인율 과대계상 → 비대칭 보정(×0.8).

**① 할인율 점수** (`discount_rate = 1 - 최저가/감정가`):

| 구간 | 점수 |
|------|------|
| ≤0 | 20 |
| 0→0.20 | 20→55 (선형) |
| 0.20→0.36 | 55→68 |
| 0.36→0.49 | 68→82 |
| 0.49→0.60 | 82→93 |
| 0.60→1.00 | 93→100 |

**② 시세 대비 점수** (`market_ratio = 최저가 / 추정시세`):

아파트: 0.40→95, 0.70→75, 0.90→40, 1.00→20 (선형 보간)
꼬마빌딩: 0.40→95, 0.70→70, 0.90→30, 1.00→10 (보다 보수적)

> **검증 질문**: 아파트 낙찰가율 평균 90%, 꼬마빌딩 70~80% 가정이 최근 시장에 맞는가?

**③ 감정가 신뢰도 점수** (`gap_ratio = |감정가 - 시세| / 시세`):
- 고평가(감정가>시세) 시 raw_score × 0.8 비대칭 보정

**신뢰도 계수:**
- HIGH (`trade_count ≥ 10`): × 1.0
- MEDIUM (`≥5`): × 0.85
- LOW: × 0.7

---

### 5-D. 통합 점수 (TotalScorer, 5E)

**4-Pillar 유형별 가중치:**

| Pillar | 아파트 | 꼬마빌딩 | 토지 |
|--------|--------|---------|------|
| 법률 (legal) | 0.20 | 0.35 | 0.25 |
| 가격 (price) | 0.25 | 0.20 | 0.15 |
| 입지 (location) | 0.30 | 0.15 | 0.50 |
| 명도 (occupancy) | 0.25 | 0.30 | 0.10 |
| **합계** | **1.00** | **1.00** | **1.00** |

**현재 가용 pillar**: 법률 + 가격 (Phase 5 기준)
**미구현**: 입지 (Phase 6), 명도 (Phase 7)

**Partial Score 처리 (재정규화):**
```
현재 꼬마빌딩 예시:
  원래 가중치: legal=0.35, price=0.20 (합=0.55)
  재정규화:    legal=0.636, price=0.364 (합=1.00)
  score_coverage = 0.55 (55%)
```

**등급 기준:**
- A: 80점 이상
- B: 60~80점
- C: 40~60점
- D: 40점 미만

> **검증 질문**: 현재 `score_coverage` 0.55 상태에서 A등급(80+)이 나올 수 있는가? 캘리브레이션 없이 현재 곡선으로 나온 점수가 실제 물건 질과 상관관계가 있는가?

---

## 6. DB 스키마 현황

**테이블 5개** (Alembic 마이그레이션 완료):

| 테이블 | 설명 | 주요 컬럼 |
|--------|------|----------|
| `auctions` | 경매 물건 기본 정보 | case_number, court, property_type, appraised_value, minimum_bid |
| `filter_results` | 1단 필터 결과 | auction_id (1:1), color, passed, rule_matches |
| `registry_events` | 등기부 이벤트 | auction_id (1:N), event_type, amount, canceled |
| `registry_analyses` | 등기부 분석 결과 | auction_id (1:1), base_right, hard_stop_flags, confidence |
| `scores` | 통합 점수 | auction_id (1:1), legal/price/total_score, grade, score_coverage |

**scores 테이블 캘리브레이션 컬럼** (5F 백테스트 준비):
- `actual_winning_bid`: 실제 낙찰가 (사후 입력)
- `actual_winning_ratio`: 낙찰가율
- `prediction_error`: 예측 오차
- `scorer_version`: "v1.0" (버전 추적)

---

## 7. 현재 데이터 현황 (2026-02-17 기준)

**수집 데이터** (서울 법원 5개, 배치 1회 실행):
- `auctions`: ~1,257건 수집
- `scores`: 해당 건 전체 (RED 제외 건 기준)
- `score_coverage`: 0.20 (법률 점수 없는 경우) ~ 0.55 (법률 점수 있는 경우)
- 등급 분포: C등급 다수 (법률+가격 기준, 입지/명도 미반영)

**한계 (현재 점수의 해석 주의):**
- 법률 점수는 등기부 분석이 완료된 건만 산출됨 (대부분 coverage=0.20 = 가격만)
- 입지·명도 미반영으로 절대 점수 낮게 나옴 (정상)
- 캘리브레이션 전이므로 등급은 상대 순위 참고용

---

## 8. 비즈니스 모델 가정

**현재 미구현, 설계 단계:**
- Public: 물건 리스트 + 색상 필터 + 점수 등급 제공 (구독 모델 예정)
- Private: 낙찰가 예측, 적정 입찰가 제안 (프리미엄 기능, 별도 DB 분리)

**비용 구조:**
- CODEF 등기부 열람: 건당 약 700원 (전자민원캐시 선불 충전)
- 현재 배치 수집은 1단만 (무료). 등기부는 on-demand.

---

## 9. 알려진 한계 및 미해결 과제

### 데이터 한계
| 항목 | 현황 | 영향 |
|------|------|------|
| 배당요구 여부 | 미수집 | 가압류 실손실 과대 or 과소 추정 가능 |
| 임차인 정보 | 미수집 | 명도 리스크 점수 불가 (Phase 7) |
| 관리비 체납 | 미수집 | 아파트 추가 부담 미반영 |
| 법원 문건 (매각물건명세서, 현황조사서) | 미파싱 | HS-F01(유치권) 탐지 불가 |
| 감정가 기준일 | 미추적 | 오래된 감정가로 시세괴리 발생 가능 |

### 알고리즘 한계
| 항목 | 현황 |
|------|------|
| 점수 곡선 캘리브레이션 | 실제 낙찰 데이터 없음 → 직관 기반 |
| 아파트/꼬마빌딩 분류 | 키워드 매칭 (법원 물건종류 텍스트 기반, 오분류 가능) |
| 말소기준권리 판별 신뢰도 | 텍스트 파싱 기반 → 복잡한 등기부에서 오류 가능 |
| 용도지역 조회 | Vworld 데이터 누락 가능 (건물에 좌표 없는 경우) |

### 시스템 한계
| 항목 | 현황 |
|------|------|
| 대법원 WAF | 과다 요청 시 IP 차단 (HTTP 400) → 요청 간격 3초 |
| CODEF 등기부 | 전자민원캐시 잔액 소진 시 수동 충전 필요 |
| 서버 안정성 | 홈서버 WiFi 환경, 단일 장애점 |

---

## 10. 테스트 현황

### Mock 테스트 (2026-02-17)

| 모듈 | 테스트 수 | 상태 |
|------|----------|------|
| 대법원 크롤러 | 61개 | ✅ |
| Enricher (데이터 보강) | 22개 | ✅ |
| FilterEngine (RED/YELLOW/GREEN) | 27개 | ✅ |
| Pipeline (1단+2단 통합) | 18개 | ✅ |
| AddressParser | 29개 | ✅ |
| RegistryMatcher | 13개 | ✅ |
| RegistryParser | 40개 | ✅ |
| RegistryAnalyzer | 35개 | ✅ |
| CODEF Registry | 62개 | ✅ |
| RegistryPipeline (2단) | 27개 | ✅ |
| DB ORM + Converter | 30개 | ✅ |
| BatchCollector | 13개 | ✅ |
| LegalScorer (5C) | 24개 | ✅ |
| PriceScorer (5D) | 22개 | ✅ |
| TotalScorer (5E) | 16개 | ✅ |
| RuleEngineV2 (5E) | 6개 | ✅ |
| API 스키마 + 엔드포인트 | 33개 | ✅ |
| 기타 | ~23개 | ✅ |
| **합계** | **~502개** | **전체 통과** |

### E2E 실전 검증 (2026-02-14, 10건 대상)

| 항목 | 성공률 | 비고 |
|------|--------|------|
| 주소 파싱 | 100% | |
| Geocode (좌표) | 60% | 지번 주소 일부 미인식 |
| 용도지역 (Vworld) | 100% | |
| 건축물대장 | 100% | |
| 실거래가 | 100% | |
| CODEF 등기부 검색 | 70% | 건물명 불일치 등 |
| 등기부 전체 (열람 포함) | 86% (6/7) | |

---

## 검증 요청 항목 요약

**경매 실무 전문가:**
1. 근저당 비율 곡선 — 아파트 ratio=0.6 기준, 꼬마빌딩 ratio=0.5 기준 적절한가?
2. 가압류 건수 감점 (1건=-20, 2건=-35, 3건+=-50) 수준이 실손실과 비례하는가?
3. 배당요구 여부 없이 가압류 리스크 점수화가 의미 있는가?
4. 현재 필터링 룰 (RED 3개, YELLOW 3개)에서 중요한 누락 항목은?
5. 아파트 낙찰가율 90%, 꼬마빌딩 70~80% 가정이 2024~2025 데이터에 맞는가?

**소프트웨어 아키텍처 전문가:**
1. Partial Score 재정규화 방식 — `score_coverage` 0.55에서 의미 있는 점수인가?
2. 점수 캘리브레이션 없이 절대 등급(A/B/C/D) 부여하는 것의 위험성?
3. 선형 보간 기반 점수 곡선의 한계 — 더 적합한 모델이 있는가?
4. 배당 우선순위 계산 없이 인수 권리 점수화의 정확도?
5. 배치 수집 → DB 저장 → 점수 산출 파이프라인의 확장성 이슈?

---

*이 문서는 실제 구현 코드 기반으로 작성되었습니다. 설계 문서가 아닌 현황 보고서입니다.*
